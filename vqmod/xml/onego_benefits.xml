<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <id>OneGo buyer benefits extension</id>
    <version>0.9.4</version>
    <vqmver>1.0.9</vqmver>
    <author>onego.com</author>
    <file name="catalog/controller/common/header.php">
        <operation>
            <search position="before"><![CDATA[
            $this->render();
            ]]></search>

            <add><![CDATA[
            if ($this->config->get('onego_status')) {
                $this->data['onego_header'] = $this->getChild('total/onego/header');
            } else {
                $this->data['onego_header'] = '';
            }
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/controller/checkout/confirm.php">
        <operation>
            <search position="before"><![CDATA[
            $this->render()
            ]]></search>

            <add><![CDATA[
            if ($this->config->get('onego_status')) {
                $this->data['onego_panel'] = $this->getChild('total/onego/panel');
            } else {
                $this->data['onego_panel'] = '';
            }
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/controller/checkout/success.php">
        <operation>
            <search position="after"><![CDATA[
            public function index() {
            ]]></search>

            <add><![CDATA[
            if ($this->config->get('onego_status')) {
                $this->data['onego_info'] = $this->getChild('total/onego/success');
            } else {
                $this->data['onego_info'] = '';
            }
            ]]></add>
        </operation>
    </file>

    <file name="catalog/controller/checkout/cart.php">
        <operation>
            <search position="after"><![CDATA[
            public function index() {
            ]]></search>

            <add><![CDATA[
            if ($this->config->get('onego_status')) {
                $this->data['onego_panel'] = $this->getChild('total/onego/panel');
            } else {
                $this->data['onego_panel'] = '';
            }
            ]]></add>
        </operation>
    </file>

    <file name="catalog/view/theme/*/template/checkout/cart.tpl">
        <operation>
            <search position="before"><![CDATA[
            <div class="cart-total">
            ]]></search>

            <add><![CDATA[
            <?php echo !empty($onego_panel) ? $onego_panel : 'onego'; ?>
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/view/theme/*/template/checkout/confirm.tpl">
        <operation>
            <search position="top"><![CDATA[
            ]]></search>

            <add><![CDATA[
            <?php echo $onego_panel ?>
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/view/theme/*/template/common/header.tpl">
        <operation>
            <search position="before"><![CDATA[
            </head>
            ]]></search>
            
            <add><![CDATA[
            <?php echo !empty($onego_header) ? $onego_header : ''; ?>
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/view/theme/*/template/common/success.tpl">
        <operation>
        <search position="after"><![CDATA[
            <?php echo $text_message; ?>
            ]]></search>
            
            <add><![CDATA[
            <?php echo !empty($onego_info) ? $onego_info : ''; ?>
            ]]></add>
        </operation>
    </file>
    
    <file name="catalog/model/checkout/order.php">
        <operation>
        <search position="replace"><![CDATA[
            public function confirm($order_id
            ]]></search>
            
            <add><![CDATA[
            // wrapper for original confirm() to always call ModelTotalOnego::confirm() in the end
            public function confirm($order_id)
            {
                call_user_func_array(
                    array($this, '_confirm_onego_wrapped'),
                    func_get_args()
                );
                
                if ($this->config->get('onego_status')) {
                    $this->load->model('total/onego');
                    $this->model_total_onego->confirmOrder($order_id);
                }
            }
            
            private function _confirm_onego_wrapped($order_id
            ]]></add>
        </operation>
    </file>
    
    <file name="admin/view/template/common/header.tpl">
        <operation>
        <search position="before"><![CDATA[
            </head>
            ]]></search>
            
            <add><![CDATA[
            <link rel="stylesheet" type="text/css" href="view/stylesheet/onego.css" />
            <script type="text/javascript" src="view/javascript/onego.js"></script>
            ]]></add>
        </operation>
    </file>
    
    <file name="admin/view/template/sale/order_info.tpl">
        <operation>
        <search position="after"><![CDATA[
            <div id="history"></div>
            ]]></search>
            
            <add><![CDATA[
            <script type="text/javascript">
            $('document').ready(function(){
                OneGoOpencart.loadOrderStatus('<?php echo $token ?>', <?php echo $order_id ?>);
            })
            </script>
            ]]></add>
        </operation>
    </file>

    <file name="admin/controller/sale/order.php">
        <operation>
        <search position="after"><![CDATA[
            $this->template = 'sale/order_list.tpl';
            ]]></search>

            <add><![CDATA[
            if ($this->config->get('onego_status') && !empty($this->data['orders'])) {
                $this->load->model('total/onego');
                $this->data['orders'] = $this->model_total_onego->addTransactionStatuses($this->data['orders']);
            }
            ]]></add>
        </operation>
    </file>
    
</modification>